<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>La Marabelle — Panier à Mirabelles (Vidéo + Niveaux)</title>
<meta name="description" content="Attrape les fruits ! 3 niveaux, gnome, pot de confiture, fast-food malus, et fond vidéo.">
<style>
  :root{
    --ink:#2b1e17; --card:#ffffffea; --shadow:0 12px 30px rgba(0,0,0,.12);
    --accent:#ffb703; --accent2:#fb8500;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; font-family: ui-rounded, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color:var(--ink); overflow:hidden; }

  /* Vidéo de fond */
  #bgVideo{
    position: fixed; inset: 0; width: 100%; height: 100%;
    object-fit: cover; z-index: -2; background:#fff9f4;
  }
  .videoOverlay{
    position: fixed; inset:0; z-index:-1;
    background: radial-gradient(100% 60% at 50% 20%, rgba(255,255,255,.15), rgba(0,0,0,.20));
    pointer-events:none;
  }

  /* Conteneur jeu */
  #game {position:relative; width:100vw; height:100vh; overflow:hidden;}

  /* HUD (nouvelle version compacte) */
  .hud{ position:absolute; top:10px; left:10px; right:10px; display:flex; gap:8px; align-items:center; z-index:5; overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .hud .chip{
    background:var(--card); border:1px solid #f0e0c8; border-radius:999px;
    padding:8px 12px; box-shadow:var(--shadow); font-weight:700; white-space:nowrap; display:flex; gap:.45rem; align-items:center;
  }
  .hud .hud-toggle{
    appearance:none; border:1px solid #f0e0c8; background:#fff; box-shadow:var(--shadow);
    border-radius:10px; padding:8px 10px; font-weight:800; cursor:pointer;
  }
  .spacer{ flex:1 }
  .btn{ appearance:none; border:0; background:var(--accent2); color:#fff; padding:10px 14px; border-radius:12px; font-weight:800; box-shadow:0 10px 18px rgba(251,133,0,.25); cursor:pointer; }
  .btn.ghost{ background:#fff; color:var(--ink); border:1px solid #f0e0c8; }

  /* État compact : cache les libellés et réduit la densité */
  .hud.hud--collapsed .lbl{ display:none; }
  .hud.hud--collapsed .chip{ padding:6px 10px; font-weight:800; }
  .hud.hud--collapsed #btnStart{
    position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
    z-index:7;
  }

  /* GNOME (remplace le panier) */
  #basket{
    position:absolute; bottom:8vh; left:50%; transform:translateX(-50%);
    width:120px; height:140px;
    background: url('Images/SVG/Gnome_Perso.svg') center bottom / contain no-repeat;
    border:none; box-shadow:none;
    transition: transform 80ms linear;
  }
  #basket.flipX{ transform: translateX(-50%) scaleX(-1); }
  #basket:before{ content:none; }

  /* Items */
  .item{ position:absolute; width:58px; height:58px; will-change:transform; }
  .item img, .item svg{ width:58px; height:58px; display:block; filter: drop-shadow(0 6px 6px rgba(0,0,0,.22)); }

  /* Effets */
  .float{ position:absolute; pointer-events:none; font-weight:900; text-shadow:0 2px 0 rgba(0,0,0,.1); animation: floatUp .8s ease-out forwards; }
  @keyframes floatUp{ from{ transform:translate(-50%,0); opacity:0 } 20%{opacity:1} to{ transform:translate(-50%,-48px); opacity:0 } }
  canvas#fx{ position:absolute; inset:0; pointer-events:none; }

  /* Overlays */
  .overlay{ position:absolute; inset:0; display:grid; place-items:center; background:rgba(255,249,244,.55); backdrop-filter: blur(2px); z-index:6; padding:20px; text-align:center; }
  .panel{ background:var(--card); border:1px solid #f0e0c8; border-radius:18px; box-shadow:var(--shadow); padding:20px; max-width:520px; }
  .panel h2{ margin:6px 0 8px } .panel p{ margin:0 0 12px }

  /* Mobile */
  @media (max-width: 480px){
    .hud .chip{ padding:6px 10px; font-size:14px; }
    .btn{ padding:10px 14px; font-size:15px; }
    .hud .hud-toggle{ padding:6px 8px; }
  }

  .credit{ position:absolute; bottom:8px; right:12px; font-size:.85rem; opacity:.8; text-shadow:0 1px 2px rgba(255,255,255,.6) }
</style>
</head>
<body>
<!-- Vidéo -->
<video id="bgVideo" autoplay loop muted playsinline>
  <source src="Images/fond.mp4" type="video/mp4">
</video>
<div class="videoOverlay"></div>

<div id="game">
  <!-- HUD (remplacée) -->
  <div class="hud hud--collapsed" id="hud">
    <button class="hud-toggle" id="hudToggle" aria-label="Afficher/masquer les libellés">☰</button>

    <div class="chip"><span class="lbl">Niveau</span><span class="val"><span id="level">1</span>/3</span></div>
    <div class="chip"><span class="lbl">Objectif</span><span class="val"><span id="progress">0</span>/<span id="target">10</span></span></div>
    <div class="chip"><span class="lbl">Score</span><span class="val" id="score">0</span></div>
    <div class="chip"><span class="lbl">Ratés</span><span class="val"><span id="miss">0</span>/<span id="missMax">0</span></span></div>
    <div class="chip"><span class="lbl">Combo</span><span class="val" id="combo">x1</span></div>
    <div class="chip"><span class="lbl">Temps</span><span class="val"><span id="time">20</span>s</span></div>

    <div class="spacer"></div>
    <button id="btnStart" class="btn">Démarrer</button>
  </div>

  <!-- Gnome + FX -->
  <div id="basket" aria-label="Gnome collecteur"></div>
  <canvas id="fx"></canvas>

  <div id="intro" class="overlay">
    <div class="panel">
      <h2>La Marabelle — Récolte du Gnome</h2>
      <p>
        Attrape les fruits 
        <span style="display:inline-block;width:32px;height:32px;vertical-align:middle">
          <img src="Images/SVG/Pomme.svg" alt="fruit" style="width:100%;height:100%">
        </span> !
        <br>
        Évite le fast-food 
        <span style="display:inline-block;width:32px;height:32px;vertical-align:middle">
          <img src="Images/SVG/Burger.svg" alt="junk" style="width:100%;height:100%">
        </span>,
        vise le gnome bonus 
        <span style="display:inline-block;width:32px;height:32px;vertical-align:middle">
          <img src="Images/SVG/Gnome.png" alt="gnome bonus" style="width:100%;height:100%">
        </span>
        (+5) et le pot
        <span style="display:inline-block;width:32px;height:32px;vertical-align:middle">
          <img src="Images/SVG/JamJar.svg" alt="pot confiture" style="width:100%;height:100%">
        </span>
        (x2 pendant 5s).
      </p>
      <p>3 niveaux : de doux à corsé. Prêt·e ?</p>
      <button class="btn" id="introStart">Jouer</button>
    </div>
  </div>

  <div id="between" class="overlay" style="display:none">
    <div class="panel">
      <h2 id="betweenTitle">Bravo !</h2>
      <p id="betweenMsg">Niveau suivant ?</p>
      <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
        <button class="btn" id="nextLevel">Niveau suivant</button>
        <button class="btn ghost" id="replayLevel">Rejouer ce niveau</button>
      </div>
    </div>
  </div>

  <div id="gameover" class="overlay" style="display:none">
    <div class="panel">
      <h2 id="overTitle">Oups…</h2>
      <p id="overMsg">Tu feras mieux la prochaine fois !</p>
      <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
        <button class="btn" id="retry">Réessayer</button>
        <button class="btn ghost" id="quit">Quitter</button>
      </div>
    </div>
  </div>

  <div class="credit">« Pour une tartine qui ne manque pas de Mara ! »</div>
</div>

<script>
/* ========= Sprites/Tags ========= */
const SVG_ROTTEN = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 58 58">
  <circle cx="29" cy="29" r="26" fill="#b56a2a" stroke="#5e2b18" stroke-width="3"/>
  <path d="M18 36 q10 -6 20 0" stroke="#2b1e17" stroke-width="4" fill="none" stroke-linecap="round"/>
  <circle cx="21" cy="27" r="4" fill="#2b1e17"/><circle cx="37" cy="27" r="4" fill="#2b1e17"/>
</svg>`;
const GNOME_TAG = `<img alt="gnome bonus" src="Images/SVG/Gnome.png" />`;
const JAMJAR_TAG = `<img alt="pot de confiture" src="Images/SVG/JamJar.svg" />`;

/* ========= Utilitaires ========= */
const $ = s => document.querySelector(s);
const game = $('#game'), basket = $('#basket');
const fx = $('#fx'); const ctx = fx.getContext('2d');
function setFxSize(){ fx.width = game.clientWidth; fx.height = game.clientHeight }
addEventListener('resize', setFxSize); setFxSize();
function rand(min,max){ return Math.random()*(max-min)+min; }
function now(){ return performance.now(); }

/* ========= FX visuels ========= */
let particles = [], anim=null;
function burst(x,y,colors=['#ffb703','#fb8500','#8ecae6','#3a7a3a']){
  for(let i=0;i<18;i++){
    particles.push({x,y,vx:rand(-2,2),vy:rand(-3,0),a:rand(0,Math.PI*2),life:rand(28,50),c:colors[i%colors.length]});
  }
  if(!anim) anim = requestAnimationFrame(drawFx);
}
function drawFx(){
  ctx.clearRect(0,0,fx.width,fx.height);
  particles.forEach(p=>{
    p.x+=p.vx; p.y+=p.vy; p.vy += .08; p.life--;
    ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a+=.1);
    ctx.fillStyle=p.c; ctx.fillRect(-3,-3,6,-6);
    ctx.restore();
  });
  particles = particles.filter(p=>p.life>0 && p.y<fx.height+8);
  anim = particles.length ? requestAnimationFrame(drawFx) : null;
}
function floatLabel(x,y,text,good=true){
  const el=document.createElement('div');
  el.className='float'; el.textContent=text;
  el.style.color = good ? '#0c8b4b' : '#b02e2e';
  el.style.left=x+'px'; el.style.top=y+'px';
  game.appendChild(el); setTimeout(()=> el.remove(), 820);
}

/* ========= Audio SFX (WebAudio, avec boost & limiteur) ========= */
let AC=null, master=null, comp=null;
const MASTER_VOLUME = 0.55; // volume global (0..2)

function initAudio(){
  if(AC) return;
  const Ctx = window.AudioContext || window.webkitAudioContext;
  if(!Ctx) return;
  AC = new Ctx();

  master = AC.createGain();
  comp = AC.createDynamicsCompressor();
  comp.threshold.value = -12; comp.knee.value = 20; comp.ratio.value = 6;
  comp.attack.value = 0.003; comp.release.value = 0.25;

  let vol = MASTER_VOLUME;
  const qp = new URLSearchParams(location.search);
  const v = parseFloat(qp.get('vol'));
  if(!Number.isNaN(v)) vol = Math.max(0, Math.min(2, v));
  master.gain.value = vol;

  master.connect(comp); comp.connect(AC.destination);
}
function resumeAudio(){ if(AC && AC.state==='suspended') AC.resume(); }
function vibrate(ms){ if(navigator.vibrate) navigator.vibrate(ms); }

function tone({freq=440, freq2=null, dur=0.12, type='sine', attack=0.005, release=0.08, vol=0.8, when=0}){
  if(!AC) return;
  const t = AC.currentTime + when;
  const o = AC.createOscillator();
  const g = AC.createGain();
  o.type = type; o.frequency.setValueAtTime(freq, t);
  if(freq2){ o.frequency.exponentialRampToValueAtTime(freq2, t+dur*0.9); }
  g.gain.setValueAtTime(0, t);
  g.gain.linearRampToValueAtTime(vol, t+attack);
  g.gain.exponentialRampToValueAtTime(0.0001, t+dur+release);
  o.connect(g); g.connect(master);
  o.start(t); o.stop(t+dur+release+0.02);
}
function noise({dur=0.05, vol=0.5, when=0}){
  if(!AC) return;
  const t = AC.currentTime + when;
  const buffer = AC.createBuffer(1, AC.sampleRate*dur, AC.sampleRate);
  const data = buffer.getChannelData(0);
  for(let i=0;i<data.length;i++) data[i] = (Math.random()*2-1)*0.5;
  const src = AC.createBufferSource(); src.buffer = buffer;
  const g = AC.createGain(); g.gain.value = vol;
  src.connect(g); g.connect(master);
  src.start(t);
}
function sfx(kind){
  if(!AC) return;
  switch(kind){
    case 'ok': tone({freq:660,freq2:880,dur:0.10,type:'triangle',vol:0.9}); break;
    case 'bad': tone({freq:220,freq2:120,dur:0.22,type:'sawtooth',vol:1.0}); break;
    case 'bonus':
      tone({freq:784,dur:0.07,type:'square',vol:0.8});
      tone({freq:988,dur:0.07,type:'square',vol:0.75, when:0.08});
      tone({freq:1175,dur:0.09,type:'square',vol:0.75, when:0.16});
      break;
    case 'power':
      tone({freq:650,freq2:980,dur:0.18,type:'sine',vol:0.9});
      tone({freq:980,freq2:1300,dur:0.16,type:'sine',vol:0.8, when:0.12});
      break;
    case 'miss':
      tone({freq:1500,dur:0.04,type:'square',vol:0.5});
      noise({dur:0.03,vol:0.25,when:0.02});
      break;
  }
}
['click','touchstart'].forEach(ev=>{
  document.addEventListener(ev, ()=>{ if(!AC){ initAudio(); } else { resumeAudio(); } }, {once:true, passive:true});
});

/* ========= Fruits/Assets ========= */
const FRUIT_FILES = [
  'Pomme.svg','Pomme rouge.svg','Poire.svg','Orange.svg','Citron.svg','Prune.svg'
];
function fruitImgTag(){
  const name = FRUIT_FILES[(Math.random()*FRUIT_FILES.length)|0];
  const src = 'Images/SVG/' + encodeURIComponent(name);
  return `<img alt="fruit" src="${src}" />`;
}
const FASTFOOD_FILES = [
  'Burger.svg','Frites.svg','Pizza.svg','Donut.svg','HotDog.svg','Burrito.svg'
];
function fastFoodImgTag(){
  const name = FASTFOOD_FILES[(Math.random()*FASTFOOD_FILES.length)|0];
  const src = 'Images/SVG/' + encodeURIComponent(name);
  return `<img alt="junk" src="${src}" />`;
}

/* ========= HUD refs ========= */
const levelLabel = $('#level'), progressEl = $('#progress'), targetEl = $('#target');
const scoreEl = $('#score'), timeEl = $('#time');
const missEl = $('#miss'), missMaxEl = $('#missMax'), comboEl = $('#combo');

/* ========= HUD compacte : toggle & auto-compact ========= */
const hud = document.getElementById('hud');
const hudToggle = document.getElementById('hudToggle');
let hudAutoTimer = null;

function setHudCollapsed(collapsed){
  hud.classList.toggle('hud--collapsed', collapsed);
}
hudToggle.addEventListener('click', ()=> setHudCollapsed(!hud.classList.contains('hud--collapsed')));

/* ========= Overlays/Buttons ========= */
const intro = $('#intro'), between = $('#between'), gameover = $('#gameover');
const betweenTitle = $('#betweenTitle'), betweenMsg = $('#betweenMsg');
const overTitle = $('#overTitle'), overMsg = $('#overMsg');
const btnStart = $('#btnStart');
$('#introStart').onclick = () => { initAudio(); resumeAudio(); startLevel(0); };
btnStart.onclick = () => { initAudio(); resumeAudio(); startLevel(levelIndex); };
$('#nextLevel').onclick = ()=> { initAudio(); resumeAudio(); startLevel(levelIndex+1); };
$('#replayLevel').onclick = ()=> { initAudio(); resumeAudio(); startLevel(levelIndex); };
$('#retry').onclick = ()=> { initAudio(); resumeAudio(); startLevel(levelIndex); };
$('#quit').onclick = ()=> { gameover.style.display='none'; intro.style.display='grid'; };

/* ========= État ========= */
let items = [], lastSpawn = 0, nextSpawnAt = 0, raf = null, tPrev = 0, timerId = null, levelIndex = 0;
let caught = 0, score = 0, timeLeft = 20, multiplier = 1, multTimeout = null;
let misses = 0, missCap = 0;       // fruits manqués (comptés seulement pour les fruits)
let streak = 0, combo = 1;         // série d’attrapages
let lastWaveT = 0;                 // chrono des vagues
let running = false;               // fige entre niveaux

/* Taille du gnome (collisions) */
const basketW = 120, basketH = 140;
/* Position initiale centrée */
let basketX = game.clientWidth/2 - basketW/2;
let lastX = basketX;

/* ========= Niveaux équilibrés ========= */
const LEVELS = [
  { target:10, duration:20, baseSpeed:140, gravity:280, spawnMin:620, spawnMax:820, waveEvery:6000, waveBoost:-220, maxSimultaneous:4, missLimit:5, weights:{ mirabelle:0.78, rotten:0.08, gnome:0.06, jar:0.08 }, comboUp:5, comboCap:4, jarDuration:5000 },
  { target:15, duration:20, baseSpeed:190, gravity:320, spawnMin:520, spawnMax:700, waveEvery:5500, waveBoost:-240, maxSimultaneous:6, missLimit:5, weights:{ mirabelle:0.72, rotten:0.12, gnome:0.06, jar:0.10 }, comboUp:4, comboCap:5, jarDuration:5000 },
  { target:20, duration:20, baseSpeed:250, gravity:360, spawnMin:420, spawnMax:620, waveEvery:5000, waveBoost:-260, maxSimultaneous:7, missLimit:4, weights:{ mirabelle:0.66, rotten:0.16, gnome:0.06, jar:0.12 }, comboUp:3, comboCap:6, jarDuration:6000 }
];

/* ========= Démarrage d'un niveau ========= */
function startLevel(i){
  if(i >= LEVELS.length){
    between.style.display='none'; intro.style.display='grid';
    betweenTitle.textContent = 'Champion·ne de la confiture !';
    return;
  }
  levelIndex = i;
  const L = LEVELS[i];

  // Reset
  intro.style.display='none'; between.style.display='none'; gameover.style.display='none';
  items.forEach(el => el.node.remove()); items = [];
  lastSpawn = 0; nextSpawnAt = 0; lastWaveT = 0;
  caught = 0; timeLeft = L.duration; multiplier = 1; clearTimeout(multTimeout);
  misses = 0; missCap = L.missLimit; streak = 0; combo = 1;

  // HUD
  scoreEl.textContent = score;
  progressEl.textContent = caught; targetEl.textContent = L.target;
  timeEl.textContent = timeLeft; levelLabel.textContent = i+1;
  missEl.textContent = misses; missMaxEl.textContent = missCap;
  comboEl.textContent = 'x' + combo;

  // Affichage HUD : desktop = ouvert / mobile = compact + auto-compact 2s
  clearTimeout(hudAutoTimer);
  if (window.matchMedia('(min-width: 769px)').matches){
    setHudCollapsed(false);
  } else {
    setHudCollapsed(false); // montrer brièvement les libellés
    hudAutoTimer = setTimeout(()=> setHudCollapsed(true), 2000);
  }

  // Timer
  clearInterval(timerId);
  timerId = setInterval(()=>{
    if (!running) return;
    timeLeft--; timeEl.textContent = timeLeft;
    if (timeLeft <= 0) { running = false; finish(false); }
  }, 1000);

  // RAF
  running = true;
  cancelAnimationFrame(raf); tPrev = now(); raf = requestAnimationFrame(tick);
}

/* ========= Fin de niveau ========= */
function finish(win){
  running = false;
  clearInterval(timerId);
  cancelAnimationFrame(raf);
  clearTimeout(multTimeout);
  items.forEach(el=>el.node.remove());
  items = [];
  nextSpawnAt = Number.POSITIVE_INFINITY;

  if(win){
    if(levelIndex < LEVELS.length-1){
      betweenTitle.textContent = 'Bravo !';
      betweenMsg.textContent = `Cap sur le niveau ${levelIndex+2} ?`;
      between.style.display='grid';
    }else{
      betweenTitle.textContent = 'Grand·e Maître des Fruits 👑';
      betweenMsg.textContent = `Score final : ${score}`;
      between.style.display='grid';
      $('#nextLevel').style.display='none';
      setTimeout(()=>$('#nextLevel').style.display='', 10);
    }
  }else{
    overTitle.textContent = 'Oups… Temps écoulé !';
    overMsg.textContent = `Récolte : ${caught}/${LEVELS[levelIndex].target} — Score : ${score}`;
    gameover.style.display='grid';
  }
}

/* ========= Utiles ========= */
function rectsOverlap(a,b){
  return a.left < b.right && a.right > b.left && a.top < b.bottom && a.bottom > b.top;
}

/* ========= Boucle jeu ========= */
function tick(ts){
  if (!running) return;
  const L = LEVELS[levelIndex];
  const dt = (ts - tPrev)/1000; tPrev = ts;

  // Planification spawn : aléatoire + vagues, cap simultanés
  if (ts >= nextSpawnAt && items.length < L.maxSimultaneous) {
    spawnOne();
    const baseDelay = rand(L.spawnMin, L.spawnMax);
    const inWave = (ts - lastWaveT) < 900;
    const waveDue = (ts - lastWaveT) > L.waveEvery;
    nextSpawnAt = ts + (baseDelay + (inWave ? L.waveBoost : 0));
    if (waveDue) lastWaveT = ts;
  }

  const H = game.clientHeight;
  const basketRect = {
    left: basketX, right: basketX + basketW,
    top:  game.clientHeight - (8*H/100) - basketH,
    bottom: game.clientHeight - (8*H/100)
  };

  for (let k = items.length-1; k >= 0; k--){
    const it = items[k];
    it.vy += L.gravity * dt;
    it.y  += it.vy * dt;
    it.node.style.transform = `translate(${it.x}px, ${it.y}px) rotate(${it.rot += it.rotSpd}deg)`;

    const itRect = {left:it.x, right:it.x+58, top:it.y, bottom:it.y+58};

    if (rectsOverlap(itRect, basketRect)){
      catchItem(it);
      items.splice(k,1);
      continue;
    }
    if (it.y > H){
      it.node.remove();
      // Raté uniquement pour les fruits
      if (it.type === 'mirabelle'){
        misses++; missEl.textContent = misses;
        streak = 0; combo = 1; comboEl.textContent = 'x1';
        sfx('miss'); vibrate(15);
        if (misses >= missCap) { running = false; finish(false); return; }
      }
      items.splice(k,1);
    }
  }
  if (running) raf = requestAnimationFrame(tick);
}

/* ========= Spawn pondéré ========= */
function spawnOne(){
  if (!running) return;
  const L = LEVELS[levelIndex];
  const r = Math.random();
  const w = L.weights;
  const cutMir = w.mirabelle;
  const cutRot = cutMir + w.rotten;
  const cutGno = cutRot + w.gnome;
  let type = 'jar';
  if (r < cutMir) type = 'mirabelle';
  else if (r < cutRot) type = 'rotten';
  else if (r < cutGno) type = 'gnome';

  const node = document.createElement('div'); node.className = `item ${type}`;
  if(type==='mirabelle'){ node.innerHTML = fruitImgTag(); }
  else if(type==='rotten'){ node.innerHTML = fastFoodImgTag(); }
  else if(type==='jar'){ node.innerHTML = JAMJAR_TAG; }
  else if(type==='gnome'){ node.innerHTML = GNOME_TAG; }

  const x = rand(10, game.clientWidth - 68), y = -70;
  const base = L.baseSpeed, vy = base + rand(-40, 40);
  const rotSpd = (Math.random()>.5?1:-1) * rand(.2, .6);
  node.style.transform = `translate(${x}px, ${y}px)`;
  game.appendChild(node);
  items.push({type, x, y, vy, rot:0, rotSpd, node});
}

/* ========= Catch / Score / Combo ========= */
function catchItem(it){
  const L = LEVELS[levelIndex];
  it.node.remove();
  const cx = it.x + 29, cy = it.y + 29;

  if (it.type === 'mirabelle'){
    caught++; progressEl.textContent = caught;

    // Combo
    streak++;
    if (streak % L.comboUp === 0 && combo < L.comboCap) {
      combo++; comboEl.textContent = 'x' + (combo * (multiplier||1));
      floatLabel(cx, cy-10, 'COMBO ↑', true);
    }

    const pts = 1 * (multiplier||1) * combo;
    score += pts; scoreEl.textContent = score;
    floatLabel(cx, cy, `+${pts}`, true); burst(cx, cy);
    sfx('ok'); vibrate(10);

    if (caught >= L.target){
      running = false;
      finish(true);
    }
    return;
  }

  if (it.type === 'rotten'){
    score = Math.max(0, score - 3);
    scoreEl.textContent = score;
    streak = 0; combo = 1; comboEl.textContent = 'x1';
    floatLabel(cx, cy, '−3 🍔', false);
    sfx('bad'); vibrate(30);
    return;
  }

  if (it.type === 'gnome'){
    const pts = 5 * (multiplier||1) * combo;
    score += pts; scoreEl.textContent = score;
    floatLabel(cx, cy, `+${pts} 🍄`, true);
    burst(cx, cy, ['#ef476f','#ffd166','#06d6a0','#118ab2']);
    sfx('bonus'); vibrate(15);
    return;
  }

  if (it.type === 'jar'){
    multiplier = 2;
    comboEl.textContent = 'x' + (combo * multiplier);
    floatLabel(cx, cy, 'x2 🍯', true);
    sfx('power'); vibrate(12);
    clearTimeout(multTimeout);
    multTimeout = setTimeout(()=>{
      multiplier = 1;
      comboEl.textContent = 'x' + combo;
    }, L.jarDuration);
  }
}

/* ========= Contrôles gnome ========= */
function clamp(v,min,max){ return v<min?min:(v>max?max:v); }
function setBasket(x){
  const newX = clamp(x - basketW/2, 0, game.clientWidth - basketW);
  if(newX > lastX){ basket.classList.remove('flipX'); }
  else if(newX < lastX){ basket.classList.add('flipX'); }
  lastX = newX;
  basketX = newX;
  basket.style.left = (basketX + basketW/2) + 'px';
}
document.addEventListener('mousemove', e=> setBasket(e.clientX));
document.addEventListener('touchmove', e=> { const t=e.touches[0]; setBasket(t.clientX); }, {passive:true});

/* ========= Démarrage ========= */
intro.style.display='grid';
</script>

<!-- Script ralenti vidéo (robuste) -->
<script>
  (function() {
    const video = document.getElementById('bgVideo');
    if (!video) return;
    const RATE = 0.5;
    function applyRate() {
      video.defaultPlaybackRate = RATE;
      video.playbackRate = RATE;
    }
    video.addEventListener('loadedmetadata', applyRate, { once: true });
    video.addEventListener('canplay', applyRate);
    video.addEventListener('play', applyRate);
    video.addEventListener('ratechange', () => { if (video.playbackRate !== RATE) applyRate(); });
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) { applyRate(); video.play().catch(()=>{}); }
    });
    applyRate();
  })();
</script>
</body>
</html>
