<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<!-- ADAPT: viewport mobile & safe area -->
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>La Marabelle ‚Äî Panier √† Mirabelles (Vid√©o + Niveaux)</title>
<meta name="description" content="Attrape les fruits ! 3 niveaux, gnome, pot de confiture, fast-food malus, fond vid√©o, profils et leaderboard.">
<style>
  :root{ --ink:#2b1e17; --card:#ffffffea; --shadow:0 12px 30px rgba(0,0,0,.12);
         --accent:#ffb703; --accent2:#fb8500; --mint:#8ecae6;
         /* ADAPT: unit√©s viewport fiables sur mobile */
         --vh: 1vh; --vw: 1vw;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: ui-rounded, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color:var(--ink); overflow:hidden;
    /* ADAPT: √©vite le zoom gestuel accidentel et les scrolls */
    touch-action: none;
    /* ADAPT: safe area */
    padding: env(safe-area-inset-top) env(safe-area-inset-right)
             env(safe-area-inset-bottom) env(safe-area-inset-left);
    background:#fff9f4;
  }

  #bgVideo{ position: fixed; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; background:#fff9f4; }
  .videoOverlay{ position: fixed; inset:0; z-index:-1; background: radial-gradient(100% 60% at 50% 20%, rgba(255,255,255,.15), rgba(0,0,0,.20)); pointer-events:none; }

  /* ADAPT: hauteur fiable bas√©e sur --vh */
  #game {position:relative; width:100vw; height: calc(var(--vh, 1vh) * 100); overflow:hidden;}

  .hud{
    position:absolute; top: max(10px, env(safe-area-inset-top));
    left: max(10px, env(safe-area-inset-left));
    right: max(10px, env(safe-area-inset-right));
    display:flex; gap:8px; align-items:center; z-index:5; overflow-x:auto; -webkit-overflow-scrolling:touch;
  }
  .hud .chip{ background:var(--card); border:1px solid #f0e0c8; border-radius:999px; padding:8px 12px; box-shadow:var(--shadow); font-weight:700; white-space:nowrap; display:flex; gap:.45rem; align-items:center; }
  .hud .hud-toggle{ appearance:none; border:1px solid #f0e0c8; background:#fff; box-shadow:var(--shadow); border-radius:10px; padding:8px 10px; font-weight:800; cursor:pointer; }
  .spacer{ flex:1 }
  .btn{ appearance:none; border:0; background:var(--accent2); color:#fff; padding:10px 14px; border-radius:12px; font-weight:800; box-shadow:0 10px 18px rgba(251,133,0,.25); cursor:pointer; }
  .btn.ghost{ background:#fff; color:var(--ink); border:1px solid #f0e0c8; }

  .hud.hud--collapsed .lbl{ display:none; }
  .hud.hud--collapsed .chip{ padding:6px 10px; font-weight:800; }

  /* ADAPT: tailles dynamiques (JS ajuste width/height) */
  #basket{ position:absolute; bottom:8vh; left:50%; transform:translateX(-50%); width:120px; height:140px;
    background: url('Images/SVG/Gnome_Perso.svg') center bottom / contain no-repeat; border:none; box-shadow:none; transition: transform 80ms linear; }
  #basket.flipX{ transform: translateX(-50%) scaleX(-1); }

  .item{ position:absolute; width:58px; height:58px; will-change:transform; }
  /* ADAPT: image s‚Äô√©tire sur la taille courante de .item (qui est recalcul√©e) */
  .item img, .item svg{ width:100%; height:100%; display:block; filter: drop-shadow(0 6px 6px rgba(0,0,0,.22)); }

  .float{ position:absolute; pointer-events:none; font-weight:900; text-shadow:0 2px 0 rgba(0,0,0,.1); animation: floatUp .8s ease-out forwards; }
  @keyframes floatUp{ from{ transform:translate(-50%,0); opacity:0 } 20%{opacity:1} to{ transform:translate(-50%,-48px); opacity:0 } }
  canvas#fx{ position:absolute; inset:0; pointer-events:none; }

  .overlay{
    position:absolute; inset:0; display:grid; place-items:center;
    background:rgba(255,249,244,.55); backdrop-filter: blur(2px);
    z-index:6; padding:20px; text-align:center;
    /* ADAPT: safe area padding */
    padding-top: calc(20px + env(safe-area-inset-top));
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
    padding-left: calc(20px + env(safe-area-inset-left));
    padding-right: calc(20px + env(safe-area-inset-right));
  }
  .panel{ background:var(--card); border:1px solid #f0e0c8; border-radius:18px; box-shadow:var(--shadow); padding:20px; max-width:640px; width:min(92vw,640px); }
  .panel h2{ margin:6px 0 8px } .panel p{ margin:0 0 12px }

  .level-splash{ position:absolute; inset:0; display:grid; place-items:center; z-index:7; pointer-events:none; background:rgba(0,0,0,.18); backdrop-filter: blur(1px); }
  .level-inner{ text-align:center; color:#fff; text-shadow:0 4px 0 rgba(0,0,0,.25), 0 10px 30px rgba(0,0,0,.35); }
  .level-title{ font-family: "Impact","Anton","Bangers", system-ui, sans-serif; letter-spacing:.02em; font-size: clamp(32px, 7vw, 72px); -webkit-text-stroke:2px rgba(0,0,0,.35); }
  .countdown{ font-family: "Press Start 2P", ui-monospace, monospace; font-size: clamp(28px, 12vw, 120px); margin-top:.2em; animation: pop .25s ease; }
  @keyframes pop{ from{transform:scale(.7); opacity:.6} to{transform:scale(1); opacity:1} }

  .avatar-grid{ display:grid; grid-template-columns:repeat(4, minmax(64px,1fr)); gap:10px; margin:10px 0 4px; }
  .avatar{ border:2px solid #e9d9b7; border-radius:14px; padding:6px; cursor:pointer; background:#fff; box-shadow:var(--shadow); position:relative; display:grid; place-items:center; }
  .avatar.selected{ outline:3px solid var(--accent); border-color:var(--accent2); }
  .avatar img{ width:72px; height:72px; object-fit:contain; display:block; }
  .name-row{ display:flex; gap:10px; align-items:center; margin:8px 0 4px; }
  .name-row input{ flex:1; padding:10px 12px; border-radius:10px; border:1px solid #e9d9b7; font-weight:700; }
  .mini-board{ background:#fff; border:1px solid #f0e0c8; border-radius:12px; padding:10px; box-shadow:var(--shadow); margin-top:12px; text-align:left; }
  .mini-board h3{ margin:0 0 6px; font-size:1rem }
  .mini-board ol{ margin:0; padding-left:1.2rem; }
  .mini-row{ display:flex; align-items:center; gap:8px; }

  .mini-avatar{
    width:22px; height:22px; border-radius:6px; overflow:hidden;
    display:inline-grid; place-items:center; background:#fff; border:1px solid #f0e0c8;
  }
  .mini-avatar img{ width:100%; height:100%; object-fit:contain; display:block; }

  @media (max-width: 480px){
    .hud .chip{ padding:6px 10px; font-size:14px; }
    .btn{ padding:10px 14px; font-size:15px; }
    .hud .hud-toggle{ padding:6px 8px; }
  }
  .credit{
    position:absolute; right: max(12px, env(safe-area-inset-right)); bottom: max(8px, env(safe-area-inset-bottom));
    font-size:.85rem; opacity:.8; text-shadow:0 1px 2px rgba(255,255,255,.6)
  }
</style>
</head>
<body>
<video id="bgVideo" autoplay loop muted playsinline>
  <source src="Images/fond.mp4" type="video/mp4">
</video>
<div class="videoOverlay"></div>

<div id="game">
  <div class="hud hud--collapsed" id="hud">
    <button class="hud-toggle" id="hudToggle" aria-label="Afficher/masquer les libell√©s">‚ò∞</button>
    <div class="chip"><span class="lbl">Objectif</span><span class="val"><span id="progress">0</span>/<span id="target">10</span></span></div>
    <div class="chip"><span class="lbl">Score</span><span class="val" id="score">0</span></div>
    <div class="chip"><span class="lbl">Temps</span><span class="val"><span id="time">20</span>s</span></div>
    <div class="spacer"></div>
  </div>

  <div id="basket" aria-label="Gnome collecteur"></div>
  <canvas id="fx"></canvas>

  <div id="levelSplash" class="level-splash" style="display:none">
    <div class="level-inner">
      <div id="levelTitle" class="level-title">Niveau 1</div>
      <div id="countdown" class="countdown">3</div>
    </div>
  </div>

  <div id="intro" class="overlay">
    <div class="panel">
      <h2>La Marabelle ‚Äî R√©colte du Gnome</h2>
      <p>
        Attrape les fruits 
        <span style="display:inline-block;width:32px;height:32px;vertical-align:middle"><img src="Images/SVG/Pomme.svg" alt="fruit" style="width:100%;height:100%"></span> !
        <br>√âvite le fast-food 
        <span style="display:inline-block;width:32px;height:32px;vertical-align:middle"><img src="Images/SVG/Burger.svg" alt="junk" style="width:100%;height:100%"></span>,
        vise le gnome 
        <span style="display:inline-block;width:32px;height:32px;vertical-align:middle"><img src="Images/SVG/Gnome.png" alt="gnome bonus" style="width:100%;height:100%"></span> (+5) et le pot
        <span style="display:inline-block;width:32px;height:32px;vertical-align:middle"><img src="Images/SVG/JamJar.svg" alt="pot confiture" style="width:100%;height:100%"></span> (x2 pendant 5s).
      </p>

      <div class="name-row">
        <label for="playerName"><strong>Ton pseudo</strong></label>
        <input id="playerName" placeholder="Ex : MaraFan" maxlength="16">
      </div>

      <div><strong>Choisis un avatar</strong></div>
      <div class="avatar-grid" id="avatarGrid"></div>

      <div class="mini-board">
        <h3>üèÜ Top 3 mondial (live)</h3>
        <ol id="top3"></ol>
      </div>

      <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:12px">
        <button class="btn" id="introStart" disabled>Jouer</button>
      </div>
      <p style="font-size:.85rem; opacity:.8; margin-top:8px">Le classement est partag√© entre tous les appareils (Stockage Supabase).</p>
    </div>
  </div>

  <div id="between" class="overlay" style="display:none">
    <div class="panel">
      <h2 id="betweenTitle">Bravo !</h2>
      <p id="betweenMsg">Niveau suivant ?</p>
      <p id="recap" style="font-size:.95rem; opacity:.9; margin-top:6px"></p>
      <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
        <button class="btn" id="nextLevel">Niveau suivant</button>
        <button class="btn ghost" id="replayLevel">Rejouer ce niveau</button>
      </div>
    </div>
  </div>

  <div id="gameover" class="overlay" style="display:none">
    <div class="panel">
      <h2 id="overTitle">Oups‚Ä¶</h2>
      <p id="overMsg">Tu feras mieux la prochaine fois !</p>
      <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
        <button class="btn" id="retry">R√©essayer</button>
        <button class="btn ghost" id="quit">Quitter</button>
      </div>
    </div>
  </div>

  <div class="credit">¬´ Pour une tartine qui ne manque pas de Mara ! ¬ª</div>
</div>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ========= Sprites/Tags ========= */
const GNOME_TAG = `<img alt="gnome bonus" src="Images/SVG/Gnome.png" />`;
const JAMJAR_TAG = `<img alt="pot de confiture" src="Images/SVG/JamJar.svg" />`;

/* ========= Utilitaires ========= */
const $ = s => document.querySelector(s);
const game = $('#game'), basket = $('#basket');
const fx = $('#fx'); const ctx = fx.getContext('2d');
function setFxSize(){ fx.width = game.clientWidth; fx.height = game.clientHeight }

/* ADAPT: viewport units fixes (iOS/Android barres UI dynamiques) */
function setViewportVars(){
  const vv = window.visualViewport;
  const h = vv ? vv.height : window.innerHeight;
  const w = vv ? vv.width  : window.innerWidth;
  document.documentElement.style.setProperty('--vh', (h/100) + 'px');
  document.documentElement.style.setProperty('--vw', (w/100) + 'px');
}
setViewportVars();
addEventListener('resize', ()=>{ setViewportVars(); setFxSize(); recalcScale(true); }, {passive:true});
addEventListener('orientationchange', ()=>{ setTimeout(()=>{ setViewportVars(); setFxSize(); recalcScale(true); }, 250); }, {passive:true});
if (window.visualViewport){
  visualViewport.addEventListener('resize', ()=>{ setViewportVars(); setFxSize(); recalcScale(true); }, {passive:true});
  visualViewport.addEventListener('scroll', ()=>{ setViewportVars(); }, {passive:true});
}
setFxSize();

function rand(min,max){ return Math.random()*(max-min)+min; }
function now(){ return performance.now(); }
function pad2(n){ return n<10?'0'+n:''+n; }
function mmss(ms){ const s=Math.max(0,Math.round(ms/1000)); const m=(s/60|0); return `${m}:${pad2(s%60)}`; }

/* ========= FX visuels ========= */
let particles = [], anim=null;
function burst(x,y,colors=['#ffb703','#fb8500','#8ecae6','#3a7a3a']){
  for(let i=0;i<18;i++){ particles.push({x,y,vx:rand(-2,2),vy:rand(-3,0),a:rand(0,Math.PI*2),life:rand(28,50),c:colors[i%colors.length]}); }
  if(!anim) anim = requestAnimationFrame(drawFx);
}
function drawFx(){
  ctx.clearRect(0,0,fx.width,fx.height);
  particles.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy += .08; p.life--; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a+=.1); ctx.fillStyle=p.c; ctx.fillRect(-3,-3,6,-6); ctx.restore();});
  particles = particles.filter(p=>p.life>0 && p.y<fx.height+8);
  anim = particles.length ? requestAnimationFrame(drawFx) : null;
}
function floatLabel(x,y,text,good=true){
  const el=document.createElement('div'); el.className='float'; el.textContent=text; el.style.color = good ? '#0c8b4b' : '#b02e2e'; el.style.left=x+'px'; el.style.top=y+'px'; game.appendChild(el); setTimeout(()=> el.remove(), 820);
}

/* ========= Audio SFX ========= */
let AC=null, master=null, comp=null;
const MASTER_VOLUME = 0.55;
function initAudio(){
  if(AC) return;
  const Ctx = window.AudioContext || window.webkitAudioContext; if(!Ctx) return;
  AC = new Ctx(); master = AC.createGain(); comp = AC.createDynamicsCompressor();
  comp.threshold.value=-12; comp.knee.value=20; comp.ratio.value=6; comp.attack.value=.003; comp.release.value=.25;
  master.gain.value = new URLSearchParams(location.search).has('vol') ? Math.max(0,Math.min(2,parseFloat(new URLSearchParams(location.search).get('vol')))) : MASTER_VOLUME;
  master.connect(comp); comp.connect(AC.destination);
}
function resumeAudio(){ if(AC && AC.state==='suspended') AC.resume(); }
function tone({freq=440,freq2=null,dur=.12,type='sine',attack=.005,release=.08,vol=.8,when=0}){ if(!AC) return; const t=AC.currentTime+when; const o=AC.createOscillator(); const g=AC.createGain(); o.type=type; o.frequency.setValueAtTime(freq,t); if(freq2) o.frequency.exponentialRampToValueAtTime(freq2,t+dur*.9); g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(vol,t+attack); g.gain.exponentialRampToValueAtTime(0.0001,t+dur+release); o.connect(g); g.connect(master); o.start(t); o.stop(t+dur+release+.02);}
function noise({dur=.05,vol=.5,when=0}){ if(!AC) return; const t=AC.currentTime+when; const b=AC.createBuffer(1,AC.sampleRate*dur,AC.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*.5; const s=AC.createBufferSource(); s.buffer=b; const g=AC.createGain(); g.gain.value=vol; s.connect(g); g.connect(master); s.start(t); }
function sfx(kind){ if(!AC) return; switch(kind){ case 'ok': tone({freq:660,freq2:880,dur:0.10,type:'triangle',vol:0.9}); break; case 'bad': tone({freq:220,freq2:120,dur:0.22,type:'sawtooth',vol:1.0}); break; case 'bonus': tone({freq:784,dur:0.07,type:'square',vol:0.8}); tone({freq:988,dur:0.07,type:'square',vol:0.75,when:.08}); tone({freq:1175,dur:0.09,type:'square',vol:0.75,when:.16}); break; case 'power': tone({freq:650,freq2:980,dur:.18,type:'sine',vol:.9}); tone({freq:980,freq2:1300,dur:.16,type:'sine',vol:.8,when:.12}); break; case 'tick': tone({freq:700,dur:.07,type:'square',vol:.7}); break; case 'go': tone({freq:1100,dur:.18,type:'sawtooth',vol:1}); break; case 'miss': tone({freq:1500,dur:.04,type:'square',vol:.5}); noise({dur:.03,vol:.25,when:.02}); break; } }
['click','touchstart'].forEach(ev=>{ document.addEventListener(ev, ()=>{ if(!AC){ initAudio(); } else { resumeAudio(); } }, {once:true, passive:true}); });

/* ========= Fruits ========= */
const FRUIT_FILES = ['Pomme.svg','Pomme rouge.svg','Poire.svg','Orange.svg','Citron.svg','Prune.svg'];
function fruitImgTag(){ const name = FRUIT_FILES[(Math.random()*FRUIT_FILES.length)|0]; const src='Images/SVG/'+encodeURIComponent(name); return `<img alt="fruit" src="${src}" />`; }
const FASTFOOD_FILES = ['Burger.svg','Frites.svg','Pizza.svg','Donut.svg','HotDog.svg','Burrito.svg'];
function fastFoodImgTag(){ const name = FASTFOOD_FILES[(Math.random()*FASTFOOD_FILES.length)|0]; const src='Images/SVG/'+encodeURIComponent(name); return `<img alt="junk" src="${src}" />`; }

/* ========= UI Refs ========= */
const progressEl = $('#progress'), targetEl = $('#target'), scoreEl = $('#score'), timeEl = $('#time');
const hud = document.getElementById('hud'); const hudToggle = document.getElementById('hudToggle');
const intro = $('#intro'), between = $('#between'), gameover = $('#gameover');
const betweenTitle = $('#betweenTitle'), betweenMsg = $('#betweenMsg'), recapEl = $('#recap');
const overTitle = $('#overTitle'), overMsg = $('#overMsg');

const levelSplash = $('#levelSplash'), levelTitle = $('#levelTitle'), countdownEl = $('#countdown');

/* ========= HUD toggle ========= */
function setHudCollapsed(c){ hud.classList.toggle('hud--collapsed', c); }
hudToggle.addEventListener('click', ()=> setHudCollapsed(!hud.classList.contains('hud--collapsed')));

/* ========= SUPABASE (temps r√©el) ========= */
const SUPABASE_URL = 'https://gpkdtsxzgcqajdoxnllw.supabase.co';     // <‚Äî remplace si besoin
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdwa2R0c3h6Z2NxYWpkb3hubGx3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MzIwMzAsImV4cCI6MjA3MTAwODAzMH0.mOgMv225hH4yX-0hm4jG-wOKdvKUtNpWNtjNEsTqOkM'; // <‚Äî remplace si besoin
let sb = null;
try{
  if(SUPABASE_URL.startsWith('http') && SUPABASE_ANON_KEY.length>10){
    sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession:false } });
  }
}catch(e){ console.warn('Supabase non initialis√©', e); }

/* API leaderboard */
async function sbUpsertPlayer({name, avatar, bestScore, lastGame}){
  if(!sb) return;
  const { error } = await sb.from('leaderboard').upsert({
    name, avatar, best_score: bestScore|0, last_game: lastGame || null, updated_at: new Date().toISOString()
  }).select();
  if(error) console.warn('upsert error', error);
}

/* R√©cup√®re le meilleur score existant pour un pseudo (pour ne jamais descendre) */
async function sbGetBestScoreByName(name){
  if(!sb) return 0;
  const { data, error } = await sb.from('leaderboard')
    .select('best_score')
    .eq('name', name)
    .limit(1)
    .maybeSingle();
  if(error){ console.warn('fetch best error', error); return 0; }
  return data?.best_score || 0;
}

/* ========= Avatars (images jointes) ========= */
const AVATAR_PATH = 'Images/SVG/'; // dossier o√π tu places Avatar_1.svg ... Avatar_4.svg
const AVATARS = [
  { id:'1', src: AVATAR_PATH + 'Avatar_1.svg', label:'Avatar 1' },
  { id:'2', src: AVATAR_PATH + 'Avatar_2.svg', label:'Avatar 2' },
  { id:'3', src: AVATAR_PATH + 'Avatar_3.svg', label:'Avatar 3' },
  { id:'4', src: AVATAR_PATH + 'Avatar_4.svg', label:'Avatar 4' },
];
function getAvatarImgById(id){
  const a = AVATARS.find(x => x.id === id) || AVATARS[0];
  return `<img src="${a.src}" alt="${a.label}" loading="lazy">`;
}

/* ========= Profil ========= */
const LS_CUR = 'LM_CUR_USER';
function getCurrentUser(){ try{ return JSON.parse(localStorage.getItem(LS_CUR)) || null; }catch{ return null; } }
function setCurrentUser(u){ localStorage.setItem(LS_CUR, JSON.stringify(u)); }

/* Top 3 (cloud) */
async function sbFetchTop3(){
  const topList = document.getElementById('top3');
  if(!sb){ topList.innerHTML = '<li>(Supabase non configur√©)</li>'; return; }
  const { data, error } = await sb.from('leaderboard')
    .select('name, avatar, best_score, updated_at')
    .order('best_score', { ascending:false })
    .order('updated_at', { ascending:false })
    .limit(3);
  if(error){ topList.innerHTML = '<li>Erreur de chargement</li>'; console.warn(error); return; }
  topList.innerHTML = '';
  if(!data || !data.length){ topList.innerHTML = '<li>Aucun score‚Ä¶ √† toi de jouer !</li>'; return; }
  data.forEach(e=>{
    const li=document.createElement('li');
    li.innerHTML = `
      <span class="mini-row">
        <span class="mini-avatar">${getAvatarImgById(e.avatar)}</span>
        <strong>${e.name}</strong> ‚Äî ${e.best_score||0} pts
      </span>`;
    topList.appendChild(li);
  });
}
function renderTop3(){ sbFetchTop3(); }

/* Abonnement temps r√©el */
if(sb){
  sb.channel('lb-realtime')
    .on('postgres_changes',{ event: '*', schema:'public', table:'leaderboard' }, ()=>{ sbFetchTop3(); })
    .subscribe();
}

/* UI avatar */
function buildAvatarGrid(){
  const grid = document.getElementById('avatarGrid'); grid.innerHTML='';
  AVATARS.forEach(a=>{
    const div = document.createElement('div'); div.className='avatar'; div.dataset.id=a.id; div.title=a.label;
    div.innerHTML = `<img src="${a.src}" alt="${a.label}" loading="lazy">`;
    div.addEventListener('click', ()=>{
      [...grid.children].forEach(c=>c.classList.remove('selected'));
      div.classList.add('selected'); document.getElementById('introStart').disabled = !document.getElementById('playerName').value.trim();
    });
    grid.appendChild(div);
  });
  if(grid.firstChild) grid.firstChild.classList.add('selected');
}
function ensureProfileUI(){
  const nameInput = document.getElementById('playerName');
  const playBtn = document.getElementById('introStart');
  const cur = getCurrentUser();
  if(cur){ nameInput.value = cur.name; playBtn.disabled = false; }
  nameInput.addEventListener('input', ()=>{ playBtn.disabled = nameInput.value.trim()===''; });
  buildAvatarGrid(); renderTop3();
}

/* ========= √âtat du jeu & ADAPT scale ========= */
let items=[], nextSpawnAt=0, raf=null, tPrev=0, timerId=null, levelIndex=0;
let caught=0, score=0, timeLeft=20, multiplier=1, multTimeout=null;
let misses=0, missCap=0, streak=0, combo=1, maxCombo=1, lastWaveT=0;
let running=false, levelStartMs=0;

/* ADAPT: dimensions bas√©es sur un √©cran de r√©f√©rence 390√ó844 */
const BASE_W = 390, BASE_H = 844;
let SCALE = 1;
let ITEM_SIZE = 58;         // sera recalcul√©
let basketW = 120, basketH = 140;
let basketX = 0, lastX = 0;

function recalcScale(applyToExisting=false){
  const W = game.clientWidth, H = game.clientHeight;
  const s = Math.min(W/BASE_W, H/BASE_H);
  SCALE = Math.max(.72, Math.min(1.6, s)); // garde des limites raisonnables
  ITEM_SIZE = Math.round(58 * SCALE);
  basketW = Math.round(120 * SCALE);
  basketH = Math.round(140 * SCALE);

  // Applique tailles
  basket.style.width = basketW + 'px';
  basket.style.height = basketH + 'px';

  if(applyToExisting){
    // adapte les items visibles si on a redimensionn√© pendant le jeu
    for(const it of items){
      it.size = ITEM_SIZE;
      it.node.style.width = it.size + 'px';
      it.node.style.height = it.size + 'px';
    }
    // recadre le panier
    setBasket(basketX + basketW/2);
  }
}
recalcScale(false);

/* Niveaux */
const LEVELS = [
  { target:10, duration:20, baseSpeed:140, gravity:280, spawnMin:620, spawnMax:820, waveEvery:6000, waveBoost:-220, maxSimultaneous:4, missLimit:5, weights:{ mirabelle:0.78, rotten:0.08, gnome:0.06, jar:0.08 }, comboUp:5, comboCap:4, jarDuration:5000 },
  { target:15, duration:20, baseSpeed:190, gravity:320, spawnMin:520, spawnMax:700, waveEvery:5500, waveBoost:-240, maxSimultaneous:6, missLimit:5, weights:{ mirabelle:0.72, rotten:0.12, gnome:0.06, jar:0.10 }, comboUp:4, comboCap:5, jarDuration:5000 },
  { target:20, duration:20, baseSpeed:250, gravity:360, spawnMin:420, spawnMax:620, waveEvery:5000, waveBoost:-260, maxSimultaneous:7, missLimit:4, weights:{ mirabelle:0.66, rotten:0.16, gnome:0.06, jar:0.12 }, comboUp:3, comboCap:6, jarDuration:6000 }
];

/* ========= D√©marrage / boutons ========= */
document.getElementById('introStart').onclick = async () => {
  initAudio(); resumeAudio();

  const nameRaw = document.getElementById('playerName').value.trim().slice(0,16);
  const name = nameRaw.replace(/[^\p{L}\p{N}_\- ]/gu,'');
  const sel = document.querySelector('.avatar.selected'); const avatar = sel ? sel.dataset.id : AVATARS[0].id;

  const cloudBest = await sbGetBestScoreByName(name);
  const cur = { name, avatar, bestScore: cloudBest|0, lastGame:null };
  setCurrentUser(cur);

  renderTop3();

  score = 0; scoreEl.textContent = '0';

  startLevel(0);
};

document.getElementById('nextLevel').onclick = () => { initAudio(); resumeAudio(); startLevel(levelIndex+1); };
document.getElementById('replayLevel').onclick=() => { initAudio(); resumeAudio(); startLevel(levelIndex); };
document.getElementById('retry').onclick     = () => { initAudio(); resumeAudio(); startLevel(levelIndex); };
document.getElementById('quit').onclick      = () => { gameover.style.display='none'; intro.style.display='grid'; ensureProfileUI(); };

/* ========= Lancement d‚Äôun niveau ========= */
function startLevel(i){
  if(i >= LEVELS.length){
    between.style.display='none'; intro.style.display='grid'; betweenTitle.textContent='Champion¬∑ne de la confiture !';
    ensureProfileUI(); return;
  }
  levelIndex=i;
  const L = LEVELS[i];

  intro.style.display='none'; between.style.display='none'; gameover.style.display='none';
  items.forEach(el=>el.node.remove()); items=[];
  nextSpawnAt=0; lastWaveT=0; caught=0; timeLeft=L.duration; multiplier=1; clearTimeout(multTimeout);
  misses=0; missCap=L.missLimit; streak=0; combo=1; maxCombo=1;

  // ADAPT: recalcul √† l‚Äôentr√©e du niveau (au cas o√π on a tourn√© l‚Äô√©cran)
  setViewportVars(); setFxSize(); recalcScale(false);
  basketX = game.clientWidth/2 - basketW/2; lastX = basketX;
  basket.style.left=(basketX + basketW/2)+'px';

  scoreEl.textContent=score; progressEl.textContent=caught; targetEl.textContent=L.target; timeEl.textContent=timeLeft;

  showCountdown(i+1, ()=> beginGameplay());
}
function beginGameplay(){
  const L = LEVELS[levelIndex];
  if (window.matchMedia('(min-width: 769px)').matches){ setHudCollapsed(false); } else { setHudCollapsed(true); }
  clearInterval(timerId);
  timerId = setInterval(()=>{ if(!running) return; timeLeft--; timeEl.textContent = timeLeft; if(timeLeft<=0){ running=false; finish(false); } },1000);
  running=true; cancelAnimationFrame(raf); tPrev=now(); levelStartMs = performance.now(); raf=requestAnimationFrame(tick);
}
function showCountdown(levelNum, onDone){
  levelTitle.textContent = `Niveau ${levelNum}`;
  levelSplash.style.display='grid'; let n=3; countdownEl.textContent=n; sfx('tick');
  const id = setInterval(()=>{
    n--;
    if(n>0){ countdownEl.textContent=n; countdownEl.style.animation='none'; void countdownEl.offsetWidth; countdownEl.style.animation='pop .25s ease'; sfx('tick'); }
    else{ clearInterval(id); countdownEl.textContent='GO!'; countdownEl.style.animation='pop .25s ease'; sfx('go'); setTimeout(()=>{ levelSplash.style.display='none'; onDone&&onDone(); }, 420); }
  }, 800);
}

/* ========= Fin de niveau : envoi Supabase + r√©cap ========= */
async function finish(win){
  running=false;
  clearInterval(timerId); cancelAnimationFrame(raf); clearTimeout(multTimeout);
  items.forEach(el=>el.node.remove()); items=[]; nextSpawnAt=Number.POSITIVE_INFINITY;

  const L = LEVELS[levelIndex];
  const elapsedMs = performance.now() - levelStartMs;
  const used = Math.min(L.duration, Math.round(elapsedMs/1000));
  const usedStr = mmss(used*1000);

  const cur = getCurrentUser();
  if(cur){
    const lastGame = { date: new Date().toISOString(), level: levelIndex+1, score, caught, target:L.target, timeUsedSec: used, misses, bestCombo:maxCombo };

    const cloudBest = await sbGetBestScoreByName(cur.name);
    const bestScore = Math.max(cloudBest||0, cur.bestScore||0, score);

    setCurrentUser({ ...cur, bestScore, lastGame });

    await sbUpsertPlayer({ name: cur.name, avatar: cur.avatar, bestScore, lastGame });
    sbFetchTop3();
  }

  if(win){
    betweenTitle.textContent = (levelIndex < LEVELS.length-1) ? 'Bravo !' : 'Grand¬∑e Ma√Ætre des Fruits üëë';
    betweenMsg.textContent = (levelIndex < LEVELS.length-1) ? `Cap sur le niveau ${levelIndex+2} ?` : `Score final : ${score}`;
    recapEl.innerHTML =
      `R√©colt√©s : <strong>${caught}</strong> / ${L.target} &nbsp;‚Ä¢&nbsp; Temps : <strong>${usedStr}</strong><br>
       Rat√©s : <strong>${misses}</strong> &nbsp;‚Ä¢&nbsp; Meilleur combo : <strong>x${maxCombo}</strong> &nbsp;‚Ä¢&nbsp; Score total : <strong>${score}</strong>`;
    between.style.display='grid';
    if(levelIndex >= LEVELS.length-1){ document.getElementById('nextLevel').style.display='none'; setTimeout(()=>document.getElementById('nextLevel').style.display='',10); }
  }else{
    overTitle.textContent='Oups‚Ä¶ Temps √©coul√© !';
    overMsg.textContent=`R√©colte : ${caught}/${L.target} ‚Äî Temps : ${usedStr} ‚Äî Score : ${score}`;
    gameover.style.display='grid';
  }
}

/* ========= Boucle ========= */
function tick(ts){
  if (!running) return;
  const L = LEVELS[levelIndex]; const dt = (ts - tPrev)/1000; tPrev = ts;

  if (ts >= nextSpawnAt && items.length < L.maxSimultaneous) {
    spawnOne();
    const baseDelay = rand(L.spawnMin, L.spawnMax);
    const inWave = (ts - lastWaveT) < 900;
    const waveDue = (ts - lastWaveT) > L.waveEvery;
    nextSpawnAt = ts + (baseDelay + (inWave ? L.waveBoost : 0));
    if (waveDue) lastWaveT = ts;
  }

  const H = game.clientHeight;
  const basketRect = { left:basketX, right:basketX+basketW, top:game.clientHeight - (8*H/100) - basketH, bottom:game.clientHeight - (8*H/100) };

  for (let k=items.length-1; k>=0; k--){
    const it = items[k];
    it.vy += L.gravity * dt; it.y += it.vy * dt;
    it.node.style.transform = `translate(${it.x}px, ${it.y}px) rotate(${it.rot += it.rotSpd}deg)`;
    const s = it.size || ITEM_SIZE;
    const itRect = {left:it.x, right:it.x+s, top:it.y, bottom:it.y+s};

    if (it.y > H){
      it.node.remove();
      if (it.type === 'mirabelle'){ misses++; if(misses >= L.missLimit){ finish(false); return; } }
      items.splice(k,1);
      continue;
    }
    if (itRect.left < basketRect.right && itRect.right > basketRect.left && itRect.top < basketRect.bottom && itRect.bottom > basketRect.top){
      catchItem(it); items.splice(k,1);
    }
  }
  if (running) raf = requestAnimationFrame(tick);
}

/* ========= Spawn ========= */
function spawnOne(){
  if (!running) return;
  const L = LEVELS[levelIndex]; const r = Math.random(); const w = L.weights;
  const cutMir=w.mirabelle, cutRot=cutMir+w.rotten, cutGno=cutRot+w.gnome;
  let type='jar'; if(r<cutMir) type='mirabelle'; else if(r<cutRot) type='rotten'; else if(r<cutGno) type='gnome';

  const node = document.createElement('div'); node.className=`item ${type}`;
  if(type==='mirabelle') node.innerHTML=fruitImgTag();
  else if(type==='rotten') node.innerHTML=fastFoodImgTag();
  else if(type==='jar') node.innerHTML=JAMJAR_TAG;
  else if(type==='gnome') node.innerHTML=GNOME_TAG;

  const x = rand(10, game.clientWidth - (ITEM_SIZE+10)), y=-ITEM_SIZE-12;
  const base=L.baseSpeed, vy=base+rand(-40,40);
  const rotSpd = (Math.random()>.5?1:-1)*rand(.2,.6);

  node.style.width = ITEM_SIZE + 'px';
  node.style.height = ITEM_SIZE + 'px';
  node.style.transform=`translate(${x}px, ${y}px)`;
  game.appendChild(node);
  items.push({type,x,y,vy,rot:0,rotSpd,node,size:ITEM_SIZE});
}

/* ========= Catch / Score / Combo ========= */
function catchItem(it){
  const L = LEVELS[levelIndex];
  it.node.remove();
  const s = it.size || ITEM_SIZE;
  const cx = it.x + s/2, cy = it.y + s/2;

  if (it.type==='mirabelle'){
    caught++; progressEl.textContent=caught;
    streak++; if (streak % L.comboUp === 0 && combo < L.comboCap){ combo++; maxCombo=Math.max(maxCombo,combo); floatLabel(cx, cy-10, 'COMBO ‚Üë', true); }
    const pts = 1 * (multiplier||1) * combo; score += pts; scoreEl.textContent=score; floatLabel(cx,cy,`+${pts}`,true); burst(cx,cy); sfx('ok');
    if (caught >= L.target){ finish(true); }
    return;
  }
  if (it.type==='rotten'){ score=Math.max(0,score-3); scoreEl.textContent=score; streak=0; combo=1; floatLabel(cx,cy,'‚àí3 üçî',false); sfx('bad'); return; }
  if (it.type==='gnome'){ const pts=5*(multiplier||1)*combo; score+=pts; scoreEl.textContent=score; floatLabel(cx,cy,`+${pts} üçÑ`,true); burst(cx,cy,['#ef476f','#ffd166','#06d6a0','#118ab2']); sfx('bonus'); return; }
  if (it.type==='jar'){ multiplier=2; floatLabel(cx,cy,'x2 üçØ',true); sfx('power'); clearTimeout(multTimeout); multTimeout=setTimeout(()=>{ multiplier=1; }, L.jarDuration); }
}

/* ========= Contr√¥les ========= */
function clamp(v,min,max){ return v<min?min:(v>max?max:v); }
function setBasket(x){
  const newX = clamp(x - basketW/2, 0, game.clientWidth - basketW);
  if(newX > lastX) basket.classList.remove('flipX'); else if(newX < lastX) basket.classList.add('flipX');
  lastX=newX; basketX=newX; basket.style.left=(basketX + basketW/2)+'px';
}
document.addEventListener('mousemove', e=> setBasket(e.clientX), {passive:true});
document.addEventListener('touchmove', e=> { const t=e.touches[0]; setBasket(t.clientX); }, {passive:true});

/* ========= D√©marrage ========= */
intro.style.display='grid';
ensureProfileUI();
</script>

<script>
  (function() {
    const video = document.getElementById('bgVideo'); if (!video) return;
    const RATE = 0.5;
    function applyRate(){ video.defaultPlaybackRate=RATE; video.playbackRate=RATE; }
    video.addEventListener('loadedmetadata', applyRate, { once: true });
    video.addEventListener('canplay', applyRate);
    video.addEventListener('play', applyRate);
    video.addEventListener('ratechange', ()=>{ if(video.playbackRate!==RATE) applyRate(); });
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ applyRate(); video.play().catch(()=>{}); } });
    applyRate();
  })();
</script>
</body>
</html>
